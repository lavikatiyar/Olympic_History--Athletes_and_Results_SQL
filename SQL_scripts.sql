/* 1. How many olympics games have been held?*/

SELECT COUNT(DISTINCT GAMES)
FROM ATHLETE_EVENTS;


/* 2. List down all Olympics games held so far.*/

SELECT DISTINCT GAMES
FROM ATHLETE_EVENTS;

--or

WITH OLYMPIC_GAMES AS
	(
		SELECT DISTINCT GAMES,
			YEAR,
			SEASON
		FROM ATHLETE_EVENTS
	)
SELECT *
FROM OLYMPIC_GAMES;


/* 3. Mention the total no of nations who participated in each olympics game?*/

SELECT GAMES,
	COUNT(DISTINCT NOC)
FROM ATHLETE_EVENTS
GROUP BY GAMES;


/* 4. Which year saw the highest and lowest no of countries participating in olympics?*/

SELECT GAMES,
	COUNT(DISTINCT NOC) TOTAL_COUNTRIES
FROM ATHLETE_EVENTS
GROUP BY 1
ORDER BY 2;

WITH COUNTRIES_PARTICIPANT AS
	(
		SELECT YEAR,
			COUNT(DISTINCT NOC) TOTAL_COUNTRIES
		FROM ATHLETE_EVENTS
		GROUP BY YEAR
	)
SELECT 
	DISTINCT MAX(TOTAL_COUNTRIES) OVER (ORDER BY TOTAL_COUNTRIES DESC) AS HIGHEST_COUNTRIES,
	MIN(TOTAL_COUNTRIES) OVER (ORDER BY TOTAL_COUNTRIES) AS LOWEST_COUNTRIES
FROM COUNTRIES_PARTICIPANT;
 

/* 5. Which nation has participated in all of the olympic games? */

SELECT N.REGION,
	COUNT(DISTINCT GAMES)
FROM NOC_REGIONS N
INNER JOIN ATHLETE_EVENTS A ON A.NOC = N.NOC
GROUP BY A.NOC,
	N.REGION
HAVING COUNT(DISTINCT GAMES) =
	(
		SELECT COUNT(DISTINCT GAMES)
		FROM ATHLETE_EVENTS
	);
--OR

WITH ALL_GAMES AS
	(
		SELECT NOC,
			COUNT(DISTINCT GAMES) "total games"
		FROM ATHLETE_EVENTS
		GROUP BY NOC
		HAVING COUNT(DISTINCT GAMES) =
			(SELECT COUNT(DISTINCT GAMES)
				FROM ATHLETE_EVENTS)
	)
SELECT N.REGION,
	"total games"
FROM NOC_REGIONS N
INNER JOIN ALL_GAMES A ON A.NOC = N.NOC;


/* 6. Identify the sport which was played in all summer olympics.*/

SELECT SPORT,
	COUNT(DISTINCT GAMES) "Total Games"
FROM ATHLETE_EVENTS
WHERE GAMES ilike '%Summer%'
GROUP BY SPORT
HAVING COUNT(DISTINCT GAMES) =
	(
		SELECT COUNT(DISTINCT GAMES)
		FROM ATHLETE_EVENTS
		WHERE GAMES ilike '%Summer%'
	);
 
 
 
/* 7. Which Sports were just played only once in the olympics? */

SELECT SPORT,
	COUNT(DISTINCT GAMES) "Total Games"
FROM ATHLETE_EVENTS
GROUP BY SPORT
HAVING COUNT(DISTINCT GAMES) = 1;


/* 8. Fetch the total no of sports played in each olympic games.*/

SELECT GAMES,
	COUNT(DISTINCT SPORT) "Total Sports"
FROM ATHLETE_EVENTS
GROUP BY GAMES
ORDER BY "Total Sports" DESC;



/* 9. Fetch details of the oldest athletes to win a gold medal.*/

SELECT *
FROM ATHLETE_EVENTS
WHERE MEDAL ilike 'gold'
	AND AGE =
		(SELECT MAX(AGE)
			FROM ATHLETE_EVENTS
			WHERE MEDAL ilike 'gold' )
ORDER BY AGE DESC;



/* 10. Find the Ratio of male and female athletes participated in all olympic games.*/

WITH MALES AS
	(SELECT COUNT(*) "Males"
		FROM ATHLETE_EVENTS
		WHERE SEX ilike 'm' ),
	FEMALES AS
	(SELECT COUNT(SEX) "Females"
		FROM ATHLETE_EVENTS
		WHERE SEX ilike 'f' )
SELECT "Males",
	"Females",
	CONCAT(ROUND("Males" ::decimal / "Females", 2), ' : ', 1) AS "M:F Ratio"
FROM MALES,
	FEMALES;
	


/* 11. Find the Ratio of male and female athletes participated in each olympic game.*/

WITH MALES AS
	(SELECT GAMES,
			COUNT(SEX) "Males"
		FROM ATHLETE_EVENTS
		WHERE SEX ilike 'm'
		GROUP BY GAMES),
	FEMALES AS
	(SELECT GAMES,
			COUNT(SEX) "Females"
		FROM ATHLETE_EVENTS
		WHERE SEX ilike 'f'
		GROUP BY GAMES)
SELECT MALES.GAMES,
	"Males",
	"Females",
	ROUND("Males" ::decimal / "Females", 2) AS "M:F Ratio"
FROM MALES
LEFT JOIN FEMALES ON MALES.GAMES = FEMALES.GAMES;



/* 12. Fetch the top 5 athletes who have won the most gold medals.*/

WITH GOLD_MEDAL_RANK AS
	(SELECT ID,
			NAME,
			COUNT(MEDAL) "Gold Medals",
			DENSE_RANK() OVER (ORDER BY COUNT(MEDAL) DESC) RANK_NUM
		FROM ATHLETE_EVENTS
		WHERE MEDAL ilike 'gold'
		GROUP BY ID,
			NAME
	)
SELECT NAME,
	"Gold Medals"
FROM GOLD_MEDAL_RANK
WHERE RANK_NUM <= 5;



/* 13. Fetch the top 5 athletes who have won the most medals (gold/silver/bronze).*/

WITH MEDAL_RANK AS
	(SELECT ID,
			NAME,
			COUNT(MEDAL) "Medals",
			DENSE_RANK() OVER (ORDER BY COUNT(MEDAL) DESC) RANK_NUM
		FROM ATHLETE_EVENTS
		WHERE MEDAL <> 'NA'
		GROUP BY ID,
			NAME
	)
SELECT NAME,
	"Medals",
	RANK_NUM
FROM MEDAL_RANK
WHERE RANK_NUM <= 5;



/* 14. Fetch the top 5 most successful countries in olympics. Success is defined by no of medals won.*/

WITH MEDAL_RANK AS
	(
		SELECT NOC,
			COUNT(MEDAL) "Medals",
			DENSE_RANK() OVER (ORDER BY COUNT(MEDAL) DESC) RANK_NUM
		FROM ATHLETE_EVENTS
		WHERE MEDAL <> 'NA'
		GROUP BY NOC
	)
SELECT REGION,
	"Medals"
FROM MEDAL_RANK
JOIN NOC_REGIONS ON NOC_REGIONS.NOC = MEDAL_RANK.NOC
WHERE RANK_NUM <= 5
ORDER BY "Medals" DESC;



/* 15. List down total gold, silver and broze medals won by each country. */

WITH GOLD AS
	(SELECT NOC,
			COUNT(MEDAL) "Gold Medals"
		FROM ATHLETE_EVENTS
		WHERE MEDAL ilike 'gold'
		GROUP BY NOC
	),
	SILVER AS
	(SELECT NOC,
			COUNT(MEDAL) "Silver Medals"
		FROM ATHLETE_EVENTS
		WHERE MEDAL ilike 'silver'
		GROUP BY NOC
	),
	BRONZE AS
	(SELECT NOC,
			COUNT(MEDAL) "Bronze Medals"
		FROM ATHLETE_EVENTS
		WHERE MEDAL ilike 'bronze'
		GROUP BY NOC
	),
	TOTAL_MEDALS AS
	(SELECT NOC,
			COUNT(MEDAL) "Total Medals"
		FROM ATHLETE_EVENTS
		WHERE MEDAL <> 'NA'
		GROUP BY NOC
	)
SELECT TOTAL_MEDALS.NOC,
	COALESCE("Gold Medals", 0)"Gold Medals",
	COALESCE("Silver Medals", 0)"Silver Medals",
	COALESCE("Bronze Medals", 0)"Bronze Medals",
	"Total Medals"
FROM TOTAL_MEDALS
LEFT OUTER JOIN GOLD ON GOLD.NOC = TOTAL_MEDALS.NOC
LEFT OUTER JOIN SILVER ON SILVER.NOC = TOTAL_MEDALS.NOC
LEFT OUTER JOIN BRONZE ON BRONZE.NOC = TOTAL_MEDALS.NOC
ORDER BY "Total Medals" DESC;



/* 16. List down total gold, silver and broze medals won by each country corresponding to each olympic games. */

SELECT REGION,
 GAMES,
 SUM(CASE WHEN MEDAL = 'Gold' THEN 1 ELSE 0 END) AS GOLD,
 SUM(CASE WHEN MEDAL in ('Silver') THEN 1 ELSE 0 END) AS SILVER,
 SUM(CASE WHEN MEDAL = 'Bronze' THEN 1 ELSE 0 END) AS BRONZE
FROM
 (
  SELECT *
  FROM ATHLETE_EVENTS
  WHERE MEDAL <> 'NA'
 ) T
JOIN NOC_REGIONS ON NOC_REGIONS.NOC = T.NOC
GROUP BY GAMES,
 REGION
ORDER BY 1;



/* 17. Identify which country won the most gold, most silver and most bronze medals in each olympic games. */

WITH CTE_GETTOTALBYNOC AS
	(SELECT GAMES,
			NOC,
			SUM(CASE WHEN MEDAL = 'Gold' THEN 1 ELSE 0 END) AS CNT_GOLD,
			SUM(CASE WHEN MEDAL = 'Silver' THEN 1 ELSE 0 END) AS CNT_SILVER,
			SUM(CASE WHEN MEDAL = 'Bronze' THEN 1 ELSE 0 END) AS CNT_BRONZE
		FROM
			(SELECT *
				FROM ATHLETE_EVENTS
				WHERE MEDAL <> 'NA' ) X
		GROUP BY GAMES,
			NOC
		ORDER BY GAMES),
	CTE_GETMAXLMEDAL AS
	(SELECT *,
			DENSE_RANK() OVER(PARTITION BY GAMES ORDER BY CNT_GOLD DESC) AS RANK_GOLD,
			DENSE_RANK() OVER(PARTITION BY GAMES ORDER BY CNT_SILVER DESC) AS RANK_SILVER,
			DENSE_RANK() OVER(PARTITION BY GAMES ORDER BY CNT_BRONZE DESC) AS RANK_BRONZE
		FROM CTE_GETTOTALBYNOC)
SELECT T1.GAMES,
	T1.MAX_GOLD,
	T2.MAX_SILVER,
	T3.MAX_BRONZE
FROM
	(SELECT GAMES,
			CONCAT(NOC, ' - ', CNT_GOLD) AS MAX_GOLD
		FROM CTE_GETMAXLMEDAL
		WHERE RANK_GOLD < 2 ) T1
JOIN
	(SELECT GAMES,
			CONCAT(NOC, ' - ', CNT_SILVER) AS MAX_SILVER
		FROM CTE_GETMAXLMEDAL
		WHERE RANK_SILVER < 2 ) T2 ON T1.GAMES = T2.GAMES
JOIN
	(SELECT GAMES,
			CONCAT(NOC, ' - ', CNT_BRONZE) AS MAX_BRONZE
		FROM CTE_GETMAXLMEDAL
		WHERE RANK_BRONZE < 2 ) T3 ON T1.GAMES = T3.GAMES;



/* 18. Identify which country won the most gold, most silver, most bronze medals and the most medals in each olympic games. */

WITH CTE_GETTOTALBYNOC AS
 (SELECT GAMES,
   NOC,
   SUM(CASE WHEN MEDAL = 'Gold' THEN 1 ELSE 0 END) AS CNT_GOLD,
   SUM(CASE WHEN MEDAL = 'Silver' THEN 1 ELSE 0 END) AS CNT_SILVER,
   SUM(CASE WHEN MEDAL = 'Bronze' THEN 1 ELSE 0 END) AS CNT_BRONZE ,
   SUM(CASE WHEN MEDAL <> 'NA' THEN 1 ELSE 0 END) AS CNT_MEDALS
  FROM
   (SELECT *
    FROM ATHLETE_EVENTS
    WHERE MEDAL <> 'NA' ) X
  GROUP BY GAMES,
   NOC
  ORDER BY GAMES
 ),
CTE_GETMAXLMEDAL AS
 (SELECT *,
   DENSE_RANK() OVER(PARTITION BY GAMES ORDER BY CNT_GOLD DESC) AS RANK_GOLD,
   DENSE_RANK() OVER(PARTITION BY GAMES ORDER BY CNT_SILVER DESC) AS RANK_SILVER,
   DENSE_RANK() OVER(PARTITION BY GAMES ORDER BY CNT_BRONZE DESC) AS RANK_BRONZE ,
   DENSE_RANK() OVER(PARTITION BY GAMES ORDER BY CNT_MEDALS DESC) AS RANK_MEDALS
  FROM CTE_GETTOTALBYNOC)
SELECT T1.GAMES,
 T1.MAX_GOLD,
 T2.MAX_SILVER,
 T3.MAX_BRONZE,
 T4.MAX_MEDALS
FROM
 (SELECT GAMES,
   CONCAT(NOC,' - ',CNT_GOLD) AS MAX_GOLD
  FROM CTE_GETMAXLMEDAL
  WHERE RANK_GOLD < 2) T1
JOIN
 (SELECT GAMES,
   CONCAT(NOC,' - ',CNT_SILVER) AS MAX_SILVER
  FROM CTE_GETMAXLMEDAL
  WHERE RANK_SILVER < 2) T2 ON T1.GAMES = T2.GAMES
JOIN
 (SELECT GAMES,
   CONCAT(NOC,' - ',CNT_BRONZE) AS MAX_BRONZE
  FROM CTE_GETMAXLMEDAL
  WHERE RANK_BRONZE < 2) T3 ON T1.GAMES = T3.GAMES
JOIN
 (SELECT GAMES,
   CONCAT(NOC,' - ',CNT_MEDALS) AS MAX_MEDALS
  FROM CTE_GETMAXLMEDAL
  WHERE RANK_MEDALS < 2) T4 ON T1.GAMES = T4.GAMES;



/* 19. Which countries have never won gold medal but have won silver/bronze medals? */

WITH GOLD AS
	(SELECT NOC,
			COUNT(MEDAL) "Gold Medals"
		FROM ATHLETE_EVENTS
		WHERE MEDAL ilike 'gold'
		GROUP BY NOC
	),
	SILVER AS
	(SELECT NOC,
			COUNT(MEDAL) "Silver Medals"
		FROM ATHLETE_EVENTS
		WHERE MEDAL ilike 'silver'
		GROUP BY NOC
	),
	BRONZE AS
	(SELECT NOC,
			COUNT(MEDAL) "Bronze Medals"
		FROM ATHLETE_EVENTS
		WHERE MEDAL ilike 'bronze'
		GROUP BY NOC
	),
	TOTAL_MEDALS AS
	(SELECT NOC,
			COUNT(MEDAL) "Total Medals"
		FROM ATHLETE_EVENTS
		WHERE MEDAL <> 'NA'
		GROUP BY NOC
	)
SELECT REGION,
	COALESCE("Silver Medals", 0)"Silver Medals",
	COALESCE("Bronze Medals", 0)"Bronze Medals"
FROM TOTAL_MEDALS
LEFT OUTER JOIN GOLD ON GOLD.NOC = TOTAL_MEDALS.NOC
LEFT OUTER JOIN SILVER ON SILVER.NOC = TOTAL_MEDALS.NOC
LEFT OUTER JOIN BRONZE ON BRONZE.NOC = TOTAL_MEDALS.NOC
JOIN NOC_REGIONS ON TOTAL_MEDALS.NOC = NOC_REGIONS.NOC
WHERE "Gold Medals" IS NULL
ORDER BY "Total Medals" DESC;



/* 20. In which Sport/event, India has won highest medals? */

WITH MEDALS AS
	(SELECT SPORT,
			COUNT(MEDAL)"total"
		FROM ATHLETE_EVENTS
		WHERE NOC ilike 'ind'
		GROUP BY SPORT
		ORDER BY COUNT(MEDAL)
	),
	RANK_SPORT AS
	(SELECT *,
			RANK() OVER(ORDER BY "total" DESC) AS "rank"
		FROM MEDALS
	)
SELECT SPORT,
	"total"
FROM RANK_SPORT
WHERE "rank" = 1;



/* 21. Break down all olympic games where india won medal for Hockey and how many medals in each olympic games. */

SELECT SPORT,
	GAMES,
	COUNT(MEDAL) "total"
FROM ATHLETE_EVENTS
WHERE NOC ilike 'ind'
	AND SPORT ilike 'hockey'
GROUP BY SPORT,
	GAMES
ORDER BY COUNT(MEDAL) DESC;

